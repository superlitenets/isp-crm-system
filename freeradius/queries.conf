# PostgreSQL queries for ISP CRM RADIUS integration
# These queries work with the radius_subscriptions table

# Authorization queries
authorize_check_query = "\
    SELECT rs.id, rs.username, 'Cleartext-Password' as attribute, rs.password as value, ':=' as op \
    FROM radius_subscriptions rs \
    WHERE rs.username = '%{SQL-User-Name}' \
    AND rs.status IN ('active', 'expired', 'suspended')"

authorize_reply_query = "\
    SELECT rs.id, rs.username, \
        CASE \
            WHEN rs.status = 'suspended' THEN 'expired-pool' \
            WHEN rs.status = 'expired' THEN 'expired-pool' \
            WHEN rs.expiry_date < NOW() THEN 'expired-pool' \
            WHEN rs.data_quota_mb > 0 AND rs.data_used_mb >= rs.data_quota_mb THEN 'expired-pool' \
            WHEN rp.ip_pool IS NOT NULL AND rp.ip_pool != '' THEN rp.ip_pool \
            ELSE '' \
        END as framed_pool, \
        CASE \
            WHEN rs.status IN ('suspended', 'expired') OR rs.expiry_date < NOW() THEN '256k/256k' \
            WHEN rs.data_quota_mb > 0 AND rs.data_used_mb >= rs.data_quota_mb THEN '256k/256k' \
            ELSE COALESCE(rp.download_speed || '/' || rp.upload_speed, '10M/10M') \
        END as rate_limit \
    FROM radius_subscriptions rs \
    LEFT JOIN radius_packages rp ON rs.package_id = rp.id \
    WHERE rs.username = '%{SQL-User-Name}'"

# Group membership query
group_membership_query = "\
    SELECT rp.name as groupname \
    FROM radius_subscriptions rs \
    LEFT JOIN radius_packages rp ON rs.package_id = rp.id \
    WHERE rs.username = '%{SQL-User-Name}' \
    AND rs.status = 'active'"

# Accounting queries
accounting_onoff_query = "\
    UPDATE radius_sessions \
    SET stopped_at = NOW(), \
        termination_cause = '%{Acct-Terminate-Cause}' \
    WHERE nas_ip_address = '%{NAS-IP-Address}' \
    AND stopped_at IS NULL"

accounting_update_query = "\
    UPDATE radius_sessions \
    SET bytes_in = '%{Acct-Input-Octets}', \
        bytes_out = '%{Acct-Output-Octets}', \
        packets_in = '%{Acct-Input-Packets}', \
        packets_out = '%{Acct-Output-Packets}', \
        session_time = '%{Acct-Session-Time}' \
    WHERE acct_session_id = '%{Acct-Session-Id}' \
    AND nas_ip_address = '%{NAS-IP-Address}'"

accounting_update_query_alt = "\
    INSERT INTO radius_sessions \
        (subscription_id, acct_session_id, nas_ip_address, nas_port_id, \
         framed_ip_address, calling_station_id, started_at, \
         bytes_in, bytes_out, packets_in, packets_out, session_time) \
    SELECT rs.id, '%{Acct-Session-Id}', '%{NAS-IP-Address}', '%{NAS-Port-Id}', \
           '%{Framed-IP-Address}', '%{Calling-Station-Id}', \
           TO_TIMESTAMP('%{Acct-Session-Time}'::integer - EXTRACT(EPOCH FROM NOW())), \
           '%{Acct-Input-Octets}', '%{Acct-Output-Octets}', \
           '%{Acct-Input-Packets}', '%{Acct-Output-Packets}', '%{Acct-Session-Time}' \
    FROM radius_subscriptions rs \
    WHERE rs.username = '%{SQL-User-Name}'"

accounting_start_query = "\
    INSERT INTO radius_sessions \
        (subscription_id, acct_session_id, nas_ip_address, nas_port_id, \
         framed_ip_address, calling_station_id, started_at) \
    SELECT rs.id, '%{Acct-Session-Id}', '%{NAS-IP-Address}', '%{NAS-Port-Id}', \
           '%{Framed-IP-Address}', '%{Calling-Station-Id}', NOW() \
    FROM radius_subscriptions rs \
    WHERE rs.username = '%{SQL-User-Name}' \
    ON CONFLICT (acct_session_id, nas_ip_address) DO NOTHING"

accounting_stop_query = "\
    UPDATE radius_sessions \
    SET stopped_at = NOW(), \
        bytes_in = '%{Acct-Input-Octets}', \
        bytes_out = '%{Acct-Output-Octets}', \
        packets_in = '%{Acct-Input-Packets}', \
        packets_out = '%{Acct-Output-Packets}', \
        session_time = '%{Acct-Session-Time}', \
        termination_cause = '%{Acct-Terminate-Cause}' \
    WHERE acct_session_id = '%{Acct-Session-Id}' \
    AND nas_ip_address = '%{NAS-IP-Address}'"

# Post-auth logging
post-auth {
    query = "\
        INSERT INTO radius_postauth \
            (username, pass, reply, authdate, nas_ip_address, calling_station_id) \
        VALUES \
            ('%{SQL-User-Name}', '%{User-Password}', '%{reply:Packet-Type}', \
             NOW(), '%{NAS-IP-Address}', '%{Calling-Station-Id}')"
}
