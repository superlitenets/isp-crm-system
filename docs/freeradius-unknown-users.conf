# FreeRADIUS configuration for unknown/unregistered users
# Add this to your /etc/freeradius/sites-enabled/default file

# In the 'authorize' section, after the sql module, add:
authorize {
    # ... existing modules ...
    
    sql
    
    # Fallback for unknown users - accept with expired pool
    if (!ok && !notfound) {
        # SQL error, reject
        reject
    }
    
    if (notfound) {
        # User not in database - assign to expired pool for captive portal
        update control {
            Auth-Type := Accept
        }
        update reply {
            Framed-Pool := "expired-pool"
            Mikrotik-Rate-Limit := "128k/128k"
            Session-Timeout := 300
            Acct-Interim-Interval := 60
        }
    }
    
    # ... rest of authorize section ...
}

# Alternative: Use unlang in post-auth if the above doesn't work
post-auth {
    # ... existing modules ...
    
    Post-Auth-Type REJECT {
        # Check if this was a "user not found" case
        if (&request:User-Name && !&control:Cleartext-Password) {
            # Allow unknown users with limited access
            update reply {
                Framed-Pool := "expired-pool"
                Mikrotik-Rate-Limit := "128k/128k"
                Session-Timeout := 300
            }
            # Change to accept
            update control {
                Auth-Type := Accept
            }
            handled
        }
    }
}
