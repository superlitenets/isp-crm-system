version: '3.8'

services:
  app:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: isp-crm-app
    ports:
      - "8080:80"
    environment:
      - DATABASE_URL=postgresql://crm:Mgathoni.2016@db:5432/ispcrm
      - PGHOST=db
      - PGPORT=5432
      - PGDATABASE=ispcrm
      - PGUSER=crm
      - PGPASSWORD=Mgathoni.2016
      - SESSION_SECRET=isp-crm-secure-session-secret-2025
      - APP_TIMEZONE=Africa/Nairobi
      - APP_DEBUG=false
    volumes:
      - uploads_data:/var/www/html/uploads
      - logs_data:/var/www/html/logs
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - isp-crm-network

  db:
    image: postgres:15-alpine
    container_name: isp-crm-db
    environment:
      - POSTGRES_USER=crm
      - POSTGRES_PASSWORD=Mgathoni.2016
      - POSTGRES_DB=ispcrm
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U crm -d ispcrm"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - isp-crm-network

  genieacs:
    image: genieacs/genieacs:latest
    container_name: isp-crm-genieacs
    environment:
      - GENIEACS_CWMP_ACCESS_LOG_FILE=/var/log/genieacs/cwmp-access.log
      - GENIEACS_NBI_ACCESS_LOG_FILE=/var/log/genieacs/nbi-access.log
      - GENIEACS_FS_ACCESS_LOG_FILE=/var/log/genieacs/fs-access.log
      - GENIEACS_UI_ACCESS_LOG_FILE=/var/log/genieacs/ui-access.log
      - GENIEACS_DEBUG_FILE=/var/log/genieacs/debug.log
      - GENIEACS_EXT_DIR=/opt/genieacs/ext
      - GENIEACS_MONGODB_CONNECTION_URL=mongodb://genieacs-mongo:27017/genieacs
    ports:
      - "7547:7547"
      - "7557:7557"
      - "7567:7567"
      - "3000:3000"
    volumes:
      - genieacs_ext:/opt/genieacs/ext
      - genieacs_logs:/var/log/genieacs
    depends_on:
      - genieacs-mongo
    restart: unless-stopped
    networks:
      - isp-crm-network

  genieacs-mongo:
    image: mongo:4.4
    container_name: isp-crm-genieacs-mongo
    volumes:
      - genieacs_mongo_data:/data/db
    restart: unless-stopped
    networks:
      - isp-crm-network

volumes:
  postgres_data:
  uploads_data:
  logs_data:
  genieacs_ext:
  genieacs_logs:
  genieacs_mongo_data:

networks:
  isp-crm-network:
    driver: bridge
