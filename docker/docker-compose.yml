services:
  app:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: isp-crm-app
    ports:
      - "8080:80"
    environment:
      - DATABASE_URL=postgresql://crm:Mgathoni.2016@db:5432/ispcrm
      - PGHOST=db
      - PGPORT=5432
      - PGDATABASE=ispcrm
      - PGUSER=crm
      - PGPASSWORD=Mgathoni.2016
      - SESSION_SECRET=isp-crm-secure-session-secret-2025
      - APP_TIMEZONE=Africa/Nairobi
      - APP_DEBUG=false
      - OLT_SERVICE_URL=http://olt-service:3001
    volumes:
      - uploads_data:/var/www/html/uploads
      - logs_data:/var/www/html/logs
      - wireguard_config:/etc/wireguard
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - isp-crm-network

  db:
    image: postgres:15-alpine
    container_name: isp-crm-db
    environment:
      - POSTGRES_USER=crm
      - POSTGRES_PASSWORD=Mgathoni.2016
      - POSTGRES_DB=ispcrm
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U crm -d ispcrm"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - isp-crm-network

  genieacs:
    image: drumsergio/genieacs:1.2.13.2
    container_name: isp-crm-genieacs
    environment:
      - GENIEACS_MONGODB_CONNECTION_URL=mongodb://genieacs-mongo:27017/genieacs
      - GENIEACS_UI_JWT_SECRET=${GENIEACS_JWT_SECRET:-isp-crm-genieacs-jwt-secret-2025}
      - GENIEACS_EXT_DIR=/opt/genieacs/ext
      - GENIEACS_CWMP_ACCESS_LOG_FILE=/var/log/genieacs/genieacs-cwmp-access.log
      - GENIEACS_NBI_ACCESS_LOG_FILE=/var/log/genieacs/genieacs-nbi-access.log
      - GENIEACS_FS_ACCESS_LOG_FILE=/var/log/genieacs/genieacs-fs-access.log
      - GENIEACS_UI_ACCESS_LOG_FILE=/var/log/genieacs/genieacs-ui-access.log
      - GENIEACS_DEBUG_FILE=/var/log/genieacs/genieacs-debug.yaml
    ports:
      - "7547:7547"
      - "7557:7557"
      - "7567:7567"
      - "3000:3000"
    volumes:
      - genieacs_ext:/opt/genieacs/ext
      - genieacs_logs:/var/log/genieacs
    depends_on:
      - genieacs-mongo
    restart: unless-stopped
    networks:
      - isp-crm-network

  genieacs-mongo:
    image: mongo:4.4
    container_name: isp-crm-genieacs-mongo
    volumes:
      - genieacs_mongo_data:/data/db
    restart: unless-stopped
    networks:
      - isp-crm-network

  olt-service:
    build:
      context: ../olt-service
      dockerfile: Dockerfile
    container_name: isp_crm_olt_service
    environment:
      - DATABASE_URL=postgresql://crm:Mgathoni.2016@db:5432/ispcrm
      - OLT_SERVICE_PORT=3001
      - PHP_API_URL=http://app:80
      - DISCOVERY_INTERVAL=*/30 * * * * *
      - SNMP_POLL_INTERVAL=30
      - SESSION_SECRET=isp-crm-secure-session-secret-2025
    ports:
      - "3001:3001"
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - isp-crm-network

  wireguard:
    image: linuxserver/wireguard:latest
    container_name: isp-crm-wireguard
    network_mode: host
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Africa/Nairobi
      - SERVERURL=auto
      - SERVERPORT=51820
      - PEERS=0
      - PEERDNS=1.1.1.1,8.8.8.8
      - INTERNAL_SUBNET=10.200.0.0/24
      - ALLOWEDIPS=0.0.0.0/0
    volumes:
      - wireguard_config:/config
      - /lib/modules:/lib/modules:ro
    restart: unless-stopped

volumes:
  postgres_data:
  uploads_data:
  logs_data:
  genieacs_mongo_data:
  genieacs_ext:
  genieacs_logs:
  wireguard_config:

networks:
  isp-crm-network:
    driver: bridge
