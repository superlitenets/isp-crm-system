sql_user_name = "%{%{Stripped-User-Name}:-%{%{User-Name}:-DEFAULT}}"

client_query = "\
    SELECT id, \
        ip_address as nasname, \
        name as shortname, \
        COALESCE(nas_type, 'mikrotik') as type, \
        NULL as server, \
        NULL as community, \
        description, \
        secret, \
        NULL as virtual_server, \
        'no' as require_message_authenticator \
    FROM radius_nas \
    WHERE is_active = true"

authorize_check_query = "\
    SELECT id, username, 'Cleartext-Password' as attribute, password as value, ':=' as op \
    FROM radius_subscriptions \
    WHERE username = '%{SQL-User-Name}' \
    AND status IN ('active', 'expired')"

authorize_reply_query = "\
    SELECT rs.id, rs.username, \
        'Mikrotik-Rate-Limit' as attribute, \
        CONCAT(rp.upload_speed, '/', rp.download_speed) as value, \
        '=' as op \
    FROM radius_subscriptions rs \
    JOIN radius_packages rp ON rs.package_id = rp.id \
    WHERE rs.username = '%{SQL-User-Name}' \
    AND rs.status = 'active' \
    AND (rs.expiry_date IS NULL OR rs.expiry_date > CURRENT_DATE) \
    AND rp.download_speed IS NOT NULL AND rp.download_speed != '' \
    UNION ALL \
    SELECT rs.id, rs.username, \
        'Session-Timeout' as attribute, \
        CASE \
            WHEN COALESCE(rp.validity_days, 0) > 0 THEN \
                (rp.validity_days * 86400)::text \
            ELSE '86400' \
        END as value, \
        '=' as op \
    FROM radius_subscriptions rs \
    JOIN radius_packages rp ON rs.package_id = rp.id \
    WHERE rs.username = '%{SQL-User-Name}' \
    AND rs.status = 'active' \
    AND (rs.expiry_date IS NULL OR rs.expiry_date > CURRENT_DATE) \
    UNION ALL \
    SELECT rs.id, rs.username, \
        'Simultaneous-Use' as attribute, \
        rp.simultaneous_sessions::text as value, \
        ':=' as op \
    FROM radius_subscriptions rs \
    JOIN radius_packages rp ON rs.package_id = rp.id \
    WHERE rs.username = '%{SQL-User-Name}' \
    AND rs.status = 'active' \
    AND (rs.expiry_date IS NULL OR rs.expiry_date > CURRENT_DATE) \
    AND COALESCE(rp.simultaneous_sessions, 0) > 0 \
    UNION ALL \
    SELECT rs.id, rs.username, \
        'Framed-IP-Address' as attribute, \
        rs.static_ip as value, \
        '=' as op \
    FROM radius_subscriptions rs \
    WHERE rs.username = '%{SQL-User-Name}' \
    AND rs.status = 'active' \
    AND (rs.expiry_date IS NULL OR rs.expiry_date > CURRENT_DATE) \
    AND rs.static_ip IS NOT NULL \
    AND rs.static_ip != '' \
    UNION ALL \
    SELECT rs.id, rs.username, \
        'Framed-Pool' as attribute, \
        COALESCE(rn.expired_pool, 'expired-pool') as value, \
        '=' as op \
    FROM radius_subscriptions rs \
    LEFT JOIN radius_nas rn ON rs.nas_id = rn.id \
    WHERE rs.username = '%{SQL-User-Name}' \
    AND (rs.status = 'expired' OR (rs.status = 'active' AND rs.expiry_date IS NOT NULL AND rs.expiry_date <= CURRENT_DATE))"

accounting {
    reference = "%{tolower:type.%{Acct-Status-Type}.query}"
    
    type {
        start {
            query = "\
                INSERT INTO radius_sessions \
                    (subscription_id, nas_id, acct_session_id, nas_ip_address, nas_port_id, \
                     framed_ip_address, mac_address, session_start, input_octets, output_octets) \
                SELECT \
                    rs.id, \
                    rn.id, \
                    '%{Acct-Session-Id}', \
                    '%{NAS-IP-Address}', \
                    '%{NAS-Port}', \
                    NULLIF('%{Framed-IP-Address}', ''), \
                    NULLIF('%{Calling-Station-Id}', ''), \
                    NOW(), \
                    0, 0 \
                FROM radius_subscriptions rs \
                LEFT JOIN radius_nas rn ON rn.ip_address = '%{NAS-IP-Address}' \
                WHERE rs.username = '%{SQL-User-Name}'"
        }
        interim-update {
            query = "\
                INSERT INTO radius_sessions \
                    (subscription_id, nas_id, acct_session_id, nas_ip_address, nas_port_id, \
                     framed_ip_address, mac_address, session_start, input_octets, output_octets, status) \
                SELECT \
                    rs.id, \
                    rn.id, \
                    '%{Acct-Session-Id}', \
                    '%{NAS-IP-Address}', \
                    '%{NAS-Port}', \
                    NULLIF('%{Framed-IP-Address}', ''), \
                    NULLIF('%{Calling-Station-Id}', ''), \
                    NOW() - INTERVAL '%{%{Acct-Session-Time}:-0} seconds', \
                    '%{%{Acct-Input-Gigawords}:-0}'::bigint * 4294967296 + '%{%{Acct-Input-Octets}:-0}'::bigint, \
                    '%{%{Acct-Output-Gigawords}:-0}'::bigint * 4294967296 + '%{%{Acct-Output-Octets}:-0}'::bigint, \
                    'active' \
                FROM radius_subscriptions rs \
                LEFT JOIN radius_nas rn ON rn.ip_address = '%{NAS-IP-Address}' \
                WHERE rs.username = '%{SQL-User-Name}' \
                ON CONFLICT (acct_session_id) DO UPDATE SET \
                    input_octets = EXCLUDED.input_octets, \
                    output_octets = EXCLUDED.output_octets, \
                    framed_ip_address = COALESCE(NULLIF(EXCLUDED.framed_ip_address, ''), radius_sessions.framed_ip_address)"
        }
        stop {
            query = "\
                UPDATE radius_sessions SET \
                    session_end = NOW(), \
                    status = 'closed', \
                    terminate_cause = '%{Acct-Terminate-Cause}', \
                    input_octets = '%{%{Acct-Input-Gigawords}:-0}'::bigint * 4294967296 + '%{%{Acct-Input-Octets}:-0}'::bigint, \
                    output_octets = '%{%{Acct-Output-Gigawords}:-0}'::bigint * 4294967296 + '%{%{Acct-Output-Octets}:-0}'::bigint \
                WHERE acct_session_id = '%{Acct-Session-Id}'"
        }
    }
}

simul_count_query = "\
    SELECT COUNT(*) \
    FROM radius_sessions \
    WHERE subscription_id = ( \
        SELECT id FROM radius_subscriptions \
        WHERE username = '%{SQL-User-Name}' \
    ) \
    AND stopped_at IS NULL"

simul_verify_query = "\
    SELECT \
        framed_ip as framedipaddress, \
        session_id as acctsessionid, \
        nas_ip as nasipaddress, \
        nas_port as nasportid, \
        mac_address as callingstationid, \
        (SELECT username FROM radius_subscriptions WHERE id = subscription_id) as username, \
        '' as framedprotocol \
    FROM radius_sessions \
    WHERE subscription_id = ( \
        SELECT id FROM radius_subscriptions \
        WHERE username = '%{SQL-User-Name}' \
    ) \
    AND stopped_at IS NULL \
    ORDER BY started_at DESC"

group_membership_query = "\
    SELECT rp.name as groupname \
    FROM radius_subscriptions rs \
    JOIN radius_packages rp ON rs.package_id = rp.id \
    WHERE rs.username = '%{SQL-User-Name}' \
    AND rs.status = 'active' \
    ORDER BY rp.id"

post-auth {
    query = "\
        INSERT INTO radpostauth \
            (username, pass, reply, authdate, nasipaddress, calledstationid, callingstationid) \
        VALUES ( \
            '%{SQL-User-Name}', \
            '%{%{User-Password}:-%{Chap-Password}}', \
            '%{reply:Packet-Type}', \
            NOW(), \
            '%{NAS-IP-Address}', \
            '%{Called-Station-Id}', \
            '%{Calling-Station-Id}')"
}
