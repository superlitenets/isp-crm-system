sql_user_name = "%{%{Stripped-User-Name}:-%{%{User-Name}:-DEFAULT}}"

client_query = "\
    SELECT id, \
        ip_address as nasname, \
        name as shortname, \
        COALESCE(nas_type, 'mikrotik') as type, \
        NULL as server, \
        NULL as community, \
        description, \
        secret, \
        NULL as virtual_server, \
        'no' as require_message_authenticator \
    FROM radius_nas \
    WHERE is_active = true"

authorize_check_query = "\
    SELECT id, username, 'Cleartext-Password' as attribute, password as value, ':=' as op \
    FROM radius_subscriptions \
    WHERE username = '%{SQL-User-Name}' \
    AND status = 'active' \
    AND (expires_at IS NULL OR expires_at > NOW())"

authorize_reply_query = "\
    SELECT rs.id, rs.username, \
        CASE \
            WHEN rp.download_speed > 0 THEN 'Mikrotik-Rate-Limit' \
            ELSE NULL \
        END as attribute, \
        CASE \
            WHEN rp.download_speed > 0 THEN \
                CONCAT(rp.upload_speed::text, 'M/', rp.download_speed::text, 'M') \
            ELSE NULL \
        END as value, \
        '=' as op \
    FROM radius_subscriptions rs \
    JOIN radius_packages rp ON rs.package_id = rp.id \
    WHERE rs.username = '%{SQL-User-Name}' \
    AND rs.status = 'active' \
    AND (rs.expires_at IS NULL OR rs.expires_at > NOW()) \
    AND rp.download_speed > 0 \
    UNION ALL \
    SELECT rs.id, rs.username, \
        'Session-Timeout' as attribute, \
        CASE \
            WHEN rp.validity_value > 0 THEN \
                (rp.validity_value * \
                    CASE rp.validity_unit \
                        WHEN 'hours' THEN 3600 \
                        WHEN 'days' THEN 86400 \
                        WHEN 'weeks' THEN 604800 \
                        WHEN 'months' THEN 2592000 \
                        ELSE 86400 \
                    END \
                )::text \
            ELSE '86400' \
        END as value, \
        '=' as op \
    FROM radius_subscriptions rs \
    JOIN radius_packages rp ON rs.package_id = rp.id \
    WHERE rs.username = '%{SQL-User-Name}' \
    AND rs.status = 'active' \
    AND (rs.expires_at IS NULL OR rs.expires_at > NOW()) \
    UNION ALL \
    SELECT rs.id, rs.username, \
        'Simultaneous-Use' as attribute, \
        rp.max_sessions::text as value, \
        ':=' as op \
    FROM radius_subscriptions rs \
    JOIN radius_packages rp ON rs.package_id = rp.id \
    WHERE rs.username = '%{SQL-User-Name}' \
    AND rs.status = 'active' \
    AND (rs.expires_at IS NULL OR rs.expires_at > NOW()) \
    AND rp.max_sessions > 0 \
    UNION ALL \
    SELECT rs.id, rs.username, \
        'Framed-IP-Address' as attribute, \
        rs.static_ip as value, \
        '=' as op \
    FROM radius_subscriptions rs \
    WHERE rs.username = '%{SQL-User-Name}' \
    AND rs.status = 'active' \
    AND (rs.expires_at IS NULL OR rs.expires_at > NOW()) \
    AND rs.static_ip IS NOT NULL \
    AND rs.static_ip != ''"

accounting_start_query = "\
    INSERT INTO radius_sessions \
        (subscription_id, nas_id, session_id, nas_ip, nas_port, \
         framed_ip, mac_address, started_at, input_octets, output_octets) \
    SELECT \
        rs.id, \
        rn.id, \
        '%{Acct-Session-Id}', \
        '%{NAS-IP-Address}', \
        '%{NAS-Port}', \
        NULLIF('%{Framed-IP-Address}', ''), \
        NULLIF('%{Calling-Station-Id}', ''), \
        TO_TIMESTAMP(%{integer:Event-Timestamp}), \
        0, 0 \
    FROM radius_subscriptions rs \
    LEFT JOIN radius_nas rn ON rn.ip_address = '%{NAS-IP-Address}' \
    WHERE rs.username = '%{SQL-User-Name}'"

accounting_interim_query = "\
    UPDATE radius_sessions SET \
        input_octets = '%{%{Acct-Input-Gigawords}:-0}'::bigint * 4294967296 + '%{%{Acct-Input-Octets}:-0}'::bigint, \
        output_octets = '%{%{Acct-Output-Gigawords}:-0}'::bigint * 4294967296 + '%{%{Acct-Output-Octets}:-0}'::bigint, \
        framed_ip = COALESCE(NULLIF('%{Framed-IP-Address}', ''), framed_ip) \
    WHERE session_id = '%{Acct-Session-Id}' \
    AND stopped_at IS NULL"

accounting_stop_query = "\
    UPDATE radius_sessions SET \
        stopped_at = TO_TIMESTAMP(%{integer:Event-Timestamp}), \
        terminate_cause = '%{Acct-Terminate-Cause}', \
        input_octets = '%{%{Acct-Input-Gigawords}:-0}'::bigint * 4294967296 + '%{%{Acct-Input-Octets}:-0}'::bigint, \
        output_octets = '%{%{Acct-Output-Gigawords}:-0}'::bigint * 4294967296 + '%{%{Acct-Output-Octets}:-0}'::bigint \
    WHERE session_id = '%{Acct-Session-Id}'"

simul_count_query = "\
    SELECT COUNT(*) \
    FROM radius_sessions \
    WHERE subscription_id = ( \
        SELECT id FROM radius_subscriptions \
        WHERE username = '%{SQL-User-Name}' \
    ) \
    AND stopped_at IS NULL"

simul_verify_query = "\
    SELECT \
        framed_ip as framedipaddress, \
        session_id as acctsessionid, \
        nas_ip as nasipaddress, \
        nas_port as nasportid, \
        mac_address as callingstationid, \
        (SELECT username FROM radius_subscriptions WHERE id = subscription_id) as username, \
        '' as framedprotocol \
    FROM radius_sessions \
    WHERE subscription_id = ( \
        SELECT id FROM radius_subscriptions \
        WHERE username = '%{SQL-User-Name}' \
    ) \
    AND stopped_at IS NULL \
    ORDER BY started_at DESC"

group_membership_query = "\
    SELECT rp.name as groupname \
    FROM radius_subscriptions rs \
    JOIN radius_packages rp ON rs.package_id = rp.id \
    WHERE rs.username = '%{SQL-User-Name}' \
    AND rs.status = 'active' \
    ORDER BY rp.id"

post-auth {
    query = "\
        INSERT INTO radpostauth \
            (username, pass, reply, authdate, nasipaddress, calledstationid, callingstationid) \
        VALUES ( \
            '%{SQL-User-Name}', \
            '%{%{User-Password}:-%{Chap-Password}}', \
            '%{reply:Packet-Type}', \
            NOW(), \
            '%{NAS-IP-Address}', \
            '%{Called-Station-Id}', \
            '%{Calling-Station-Id}')"
}
