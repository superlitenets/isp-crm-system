sql_user_name = "%{%{Stripped-User-Name}:-%{%{User-Name}:-DEFAULT}}"

client_query = "\
    SELECT id, \
        ip_address as nasname, \
        name as shortname, \
        COALESCE(nas_type, 'mikrotik') as type, \
        NULL as server, \
        NULL as community, \
        description, \
        secret, \
        NULL as virtual_server, \
        'no' as require_message_authenticator \
    FROM radius_nas \
    WHERE is_active = true"

authorize_check_query = "\
    SELECT id, username, 'Cleartext-Password' as attribute, password as value, ':=' as op \
    FROM radius_subscriptions \
    WHERE UPPER(username) = UPPER('%{SQL-User-Name}') \
    AND LOWER(status) IN ('active', 'expired')"

authorize_reply_query = "\
    SELECT rs.id, rs.username, \
        'Mikrotik-Rate-Limit' as attribute, \
        CONCAT(rp.upload_speed, '/', rp.download_speed) as value, \
        '=' as op \
    FROM radius_subscriptions rs \
    JOIN radius_packages rp ON rs.package_id = rp.id \
    WHERE UPPER(rs.username) = UPPER('%{SQL-User-Name}') \
    AND LOWER(rs.status) = 'active' \
    AND (rs.expiry_date IS NULL OR rs.expiry_date > CURRENT_DATE) \
    AND rp.download_speed IS NOT NULL AND rp.download_speed != '' \
    UNION ALL \
    SELECT rs.id, rs.username, \
        'Session-Timeout' as attribute, \
        CASE \
            WHEN COALESCE(rp.validity_days, 0) > 0 THEN \
                (rp.validity_days * 86400)::text \
            ELSE '86400' \
        END as value, \
        '=' as op \
    FROM radius_subscriptions rs \
    JOIN radius_packages rp ON rs.package_id = rp.id \
    WHERE UPPER(rs.username) = UPPER('%{SQL-User-Name}') \
    AND LOWER(rs.status) = 'active' \
    AND (rs.expiry_date IS NULL OR rs.expiry_date > CURRENT_DATE) \
    UNION ALL \
    SELECT rs.id, rs.username, \
        'Simultaneous-Use' as attribute, \
        rp.simultaneous_sessions::text as value, \
        ':=' as op \
    FROM radius_subscriptions rs \
    JOIN radius_packages rp ON rs.package_id = rp.id \
    WHERE UPPER(rs.username) = UPPER('%{SQL-User-Name}') \
    AND LOWER(rs.status) = 'active' \
    AND (rs.expiry_date IS NULL OR rs.expiry_date > CURRENT_DATE) \
    AND COALESCE(rp.simultaneous_sessions, 0) > 0 \
    UNION ALL \
    SELECT rs.id, rs.username, \
        'Framed-IP-Address' as attribute, \
        rs.static_ip as value, \
        '=' as op \
    FROM radius_subscriptions rs \
    WHERE UPPER(rs.username) = UPPER('%{SQL-User-Name}') \
    AND LOWER(rs.status) = 'active' \
    AND (rs.expiry_date IS NULL OR rs.expiry_date > CURRENT_DATE) \
    AND rs.static_ip IS NOT NULL \
    AND rs.static_ip != '' \
    UNION ALL \
    SELECT rs.id, rs.username, \
        'Framed-Pool' as attribute, \
        COALESCE(rn.expired_pool, 'expired-pool') as value, \
        '=' as op \
    FROM radius_subscriptions rs \
    LEFT JOIN radius_nas rn ON rs.nas_id = rn.id \
    WHERE UPPER(rs.username) = UPPER('%{SQL-User-Name}') \
    AND (LOWER(rs.status) = 'expired' OR (LOWER(rs.status) = 'active' AND rs.expiry_date IS NOT NULL AND rs.expiry_date <= CURRENT_DATE)) \
    UNION ALL \
    SELECT rs.id, rs.username, \
        'Mikrotik-Rate-Limit' as attribute, \
        '128k/128k' as value, \
        '=' as op \
    FROM radius_subscriptions rs \
    WHERE UPPER(rs.username) = UPPER('%{SQL-User-Name}') \
    AND (LOWER(rs.status) = 'expired' OR (LOWER(rs.status) = 'active' AND rs.expiry_date IS NOT NULL AND rs.expiry_date <= CURRENT_DATE)) \
    UNION ALL \
    SELECT rs.id, rs.username, \
        'Session-Timeout' as attribute, \
        '300' as value, \
        '=' as op \
    FROM radius_subscriptions rs \
    WHERE UPPER(rs.username) = UPPER('%{SQL-User-Name}') \
    AND (LOWER(rs.status) = 'expired' OR (LOWER(rs.status) = 'active' AND rs.expiry_date IS NOT NULL AND rs.expiry_date <= CURRENT_DATE))"

accounting {
    reference = "%{tolower:type.%{Acct-Status-Type}.query}"
    
    type {
        start {
            query = "\
                INSERT INTO radius_sessions \
                    (subscription_id, nas_id, acct_session_id, nas_ip_address, nas_port_id, \
                     framed_ip_address, mac_address, session_start, input_octets, output_octets) \
                SELECT \
                    rs.id, \
                    rn.id, \
                    '%{Acct-Session-Id}', \
                    '%{NAS-IP-Address}', \
                    '%{NAS-Port}', \
                    NULLIF('%{Framed-IP-Address}', ''), \
                    NULLIF('%{Calling-Station-Id}', ''), \
                    NOW(), \
                    0, 0 \
                FROM radius_subscriptions rs \
                LEFT JOIN radius_nas rn ON rn.ip_address = '%{NAS-IP-Address}' \
                WHERE rs.username = '%{SQL-User-Name}'"
        }
        interim-update {
            query = "\
                INSERT INTO radius_sessions \
                    (subscription_id, nas_id, acct_session_id, nas_ip_address, nas_port_id, \
                     framed_ip_address, mac_address, session_start, input_octets, output_octets, status) \
                SELECT \
                    rs.id, \
                    rn.id, \
                    '%{Acct-Session-Id}', \
                    '%{NAS-IP-Address}', \
                    '%{NAS-Port}', \
                    NULLIF('%{Framed-IP-Address}', ''), \
                    NULLIF('%{Calling-Station-Id}', ''), \
                    NOW() - INTERVAL '%{%{Acct-Session-Time}:-0} seconds', \
                    '%{%{Acct-Input-Gigawords}:-0}'::bigint * 4294967296 + '%{%{Acct-Input-Octets}:-0}'::bigint, \
                    '%{%{Acct-Output-Gigawords}:-0}'::bigint * 4294967296 + '%{%{Acct-Output-Octets}:-0}'::bigint, \
                    'active' \
                FROM radius_subscriptions rs \
                LEFT JOIN radius_nas rn ON rn.ip_address = '%{NAS-IP-Address}' \
                WHERE rs.username = '%{SQL-User-Name}' \
                ON CONFLICT (acct_session_id) DO UPDATE SET \
                    input_octets = EXCLUDED.input_octets, \
                    output_octets = EXCLUDED.output_octets, \
                    framed_ip_address = COALESCE(NULLIF(EXCLUDED.framed_ip_address, ''), radius_sessions.framed_ip_address)"
        }
        stop {
            query = "\
                UPDATE radius_sessions SET \
                    session_end = NOW(), \
                    status = 'closed', \
                    terminate_cause = '%{Acct-Terminate-Cause}', \
                    input_octets = '%{%{Acct-Input-Gigawords}:-0}'::bigint * 4294967296 + '%{%{Acct-Input-Octets}:-0}'::bigint, \
                    output_octets = '%{%{Acct-Output-Gigawords}:-0}'::bigint * 4294967296 + '%{%{Acct-Output-Octets}:-0}'::bigint \
                WHERE acct_session_id = '%{Acct-Session-Id}'"
        }
    }
}

simul_count_query = "\
    SELECT COUNT(*) \
    FROM radius_sessions \
    WHERE subscription_id = ( \
        SELECT id FROM radius_subscriptions \
        WHERE username = '%{SQL-User-Name}' \
    ) \
    AND stopped_at IS NULL"

simul_verify_query = "\
    SELECT \
        framed_ip as framedipaddress, \
        session_id as acctsessionid, \
        nas_ip as nasipaddress, \
        nas_port as nasportid, \
        mac_address as callingstationid, \
        (SELECT username FROM radius_subscriptions WHERE id = subscription_id) as username, \
        '' as framedprotocol \
    FROM radius_sessions \
    WHERE subscription_id = ( \
        SELECT id FROM radius_subscriptions \
        WHERE username = '%{SQL-User-Name}' \
    ) \
    AND stopped_at IS NULL \
    ORDER BY started_at DESC"

group_membership_query = "\
    SELECT rp.name as groupname \
    FROM radius_subscriptions rs \
    JOIN radius_packages rp ON rs.package_id = rp.id \
    WHERE rs.username = '%{SQL-User-Name}' \
    AND rs.status = 'active' \
    ORDER BY rp.id"

post-auth {
    query = "\
        INSERT INTO radius_auth_logs \
            (subscription_id, username, nas_ip_address, mac_address, auth_result, reject_reason, created_at) \
        SELECT \
            rs.id, \
            '%{SQL-User-Name}', \
            '%{NAS-IP-Address}', \
            '%{Calling-Station-Id}', \
            CASE WHEN '%{reply:Packet-Type}' = 'Access-Accept' THEN 'Accept' ELSE 'Reject' END, \
            CASE \
                WHEN '%{reply:Packet-Type}' = 'Access-Accept' THEN 'Active user' \
                WHEN '%{reply:Reply-Message}' != '' THEN '%{reply:Reply-Message}' \
                ELSE 'Authentication failed' \
            END, \
            NOW() \
        FROM radius_subscriptions rs \
        WHERE rs.username = '%{SQL-User-Name}' \
        UNION ALL \
        SELECT \
            NULL, \
            '%{SQL-User-Name}', \
            '%{NAS-IP-Address}', \
            '%{Calling-Station-Id}', \
            CASE WHEN '%{reply:Packet-Type}' = 'Access-Accept' THEN 'Accept' ELSE 'Reject' END, \
            CASE \
                WHEN '%{reply:Packet-Type}' = 'Access-Accept' THEN 'Unknown user - allowed' \
                ELSE 'User not found' \
            END, \
            NOW() \
        WHERE NOT EXISTS (SELECT 1 FROM radius_subscriptions WHERE username = '%{SQL-User-Name}') \
        LIMIT 1"
    
    # Post-Auth-Type REJECT - returns expired pool for invalid password redirect
    reject {
        query = "\
            WITH log_insert AS ( \
                INSERT INTO radius_auth_log \
                    (subscription_id, username, result, reason, auth_time, nas_ip, mac_address) \
                SELECT \
                    rs.id, \
                    '%{SQL-User-Name}', \
                    'Accept', \
                    'Invalid password', \
                    NOW(), \
                    '%{NAS-IP-Address}', \
                    '%{Calling-Station-Id}' \
                FROM radius_subscriptions rs \
                WHERE UPPER(rs.username) = UPPER('%{SQL-User-Name}') \
                RETURNING 1 \
            ) \
            SELECT 'Framed-Pool' as attribute, \
                COALESCE((SELECT value FROM radius_settings WHERE key = 'expired_pool_name'), 'expired-pool') as value, \
                ':=' as op \
            UNION ALL \
            SELECT 'Mikrotik-Rate-Limit', '128k/128k', ':=' \
            UNION ALL \
            SELECT 'Session-Timeout', '300', ':='"
    }
}
