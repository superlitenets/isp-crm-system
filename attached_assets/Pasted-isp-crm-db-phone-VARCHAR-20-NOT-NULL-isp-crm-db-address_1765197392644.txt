isp_crm_db        |             phone VARCHAR(20) NOT NULL,
isp_crm_db        |             address TEXT NOT NULL,
isp_crm_db        |             service_plan VARCHAR(50) NOT NULL,
isp_crm_db        |             connection_status VARCHAR(20) DEFAULT 'active',
isp_crm_db        |             installation_date DATE,
isp_crm_db        |             notes TEXT,
isp_crm_db        |             created_by INTEGER REFERENCES users(id) ON DELET                                                E SET NULL,
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS tickets (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             ticket_number VARCHAR(20) UNIQUE NOT NULL,
isp_crm_db        |             customer_id INTEGER REFERENCES customers(id) ON                                                 DELETE CASCADE,
isp_crm_db        |             assigned_to INTEGER REFERENCES users(id) ON DELE                                                TE SET NULL,
isp_crm_db        |             created_by INTEGER REFERENCES users(id) ON DELET                                                E SET NULL,
isp_crm_db        |             subject VARCHAR(200) NOT NULL,
isp_crm_db        |             description TEXT NOT NULL,
isp_crm_db        |             category VARCHAR(50) NOT NULL,
isp_crm_db        |             priority VARCHAR(20) DEFAULT 'medium',
isp_crm_db        |             status VARCHAR(20) DEFAULT 'open',
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             resolved_at TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS ticket_comments (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             ticket_id INTEGER REFERENCES tickets(id) ON DELE                                                TE CASCADE,
isp_crm_db        |             user_id INTEGER REFERENCES users(id) ON DELETE S                                                ET NULL,
isp_crm_db        |             comment TEXT NOT NULL,
isp_crm_db        |             is_internal BOOLEAN DEFAULT FALSE,
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS sms_logs (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             ticket_id INTEGER REFERENCES tickets(id) ON DELE                                                TE CASCADE,
isp_crm_db        |             recipient_phone VARCHAR(20) NOT NULL,
isp_crm_db        |             recipient_type VARCHAR(20) NOT NULL,
isp_crm_db        |             message TEXT NOT NULL,
isp_crm_db        |             status VARCHAR(20) DEFAULT 'pending',
isp_crm_db        |             sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS departments (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             name VARCHAR(100) NOT NULL,
isp_crm_db        |             description TEXT,
isp_crm_db        |             manager_id INTEGER,
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS employees (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             employee_id VARCHAR(20) UNIQUE NOT NULL,
isp_crm_db        |             user_id INTEGER REFERENCES users(id) ON DELETE S                                                ET NULL,
isp_crm_db        |             name VARCHAR(100) NOT NULL,
isp_crm_db        |             email VARCHAR(100),
isp_crm_db        |             phone VARCHAR(20) NOT NULL,
isp_crm_db        |             department_id INTEGER REFERENCES departments(id)                                                 ON DELETE SET NULL,
isp_crm_db        |             position VARCHAR(100) NOT NULL,
isp_crm_db        |             salary DECIMAL(12, 2),
isp_crm_db        |             hire_date DATE,
isp_crm_db        |             employment_status VARCHAR(20) DEFAULT 'active',
isp_crm_db        |             emergency_contact VARCHAR(100),
isp_crm_db        |             emergency_phone VARCHAR(20),
isp_crm_db        |             address TEXT,
isp_crm_db        |             notes TEXT,
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         ALTER TABLE departments DROP CONSTRAINT IF EXISTS fk                                                _manager;
isp_crm_db        |         DO $$ BEGIN
isp_crm_db        |             IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE                                                 conname = 'fk_manager') THEN
isp_crm_db        |                 ALTER TABLE departments ADD CONSTRAINT fk_ma                                                nager FOREIGN KEY (manager_id) REFERENCES employees(id) ON DELETE SET NULL;
isp_crm_db        |             END IF;
isp_crm_db        |         END $$;
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS attendance (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             employee_id INTEGER REFERENCES employees(id) ON                                                 DELETE CASCADE,
isp_crm_db        |             date DATE NOT NULL,
isp_crm_db        |             clock_in TIME,
isp_crm_db        |             clock_out TIME,
isp_crm_db        |             clock_in_latitude DECIMAL(10, 8),
isp_crm_db        |             clock_in_longitude DECIMAL(11, 8),
isp_crm_db        |             clock_out_latitude DECIMAL(10, 8),
isp_crm_db        |             clock_out_longitude DECIMAL(11, 8),
isp_crm_db        |             clock_in_address TEXT,
isp_crm_db        |             clock_out_address TEXT,
isp_crm_db        |             status VARCHAR(20) DEFAULT 'present',
isp_crm_db        |             hours_worked DECIMAL(5, 2),
isp_crm_db        |             overtime_hours DECIMAL(5, 2) DEFAULT 0,
isp_crm_db        |             notes TEXT,
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             UNIQUE(employee_id, date)
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS payroll (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             employee_id INTEGER REFERENCES employees(id) ON                                                 DELETE CASCADE,
isp_crm_db        |             pay_period_start DATE NOT NULL,
isp_crm_db        |             pay_period_end DATE NOT NULL,
isp_crm_db        |             base_salary DECIMAL(12, 2) NOT NULL,
isp_crm_db        |             overtime_pay DECIMAL(12, 2) DEFAULT 0,
isp_crm_db        |             bonuses DECIMAL(12, 2) DEFAULT 0,
isp_crm_db        |             deductions DECIMAL(12, 2) DEFAULT 0,
isp_crm_db        |             tax DECIMAL(12, 2) DEFAULT 0,
isp_crm_db        |             net_pay DECIMAL(12, 2) NOT NULL,
isp_crm_db        |             status VARCHAR(20) DEFAULT 'pending',
isp_crm_db        |             payment_date DATE,
isp_crm_db        |             payment_method VARCHAR(50),
isp_crm_db        |             notes TEXT,
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS performance_reviews (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             employee_id INTEGER REFERENCES employees(id) ON                                                 DELETE CASCADE,
isp_crm_db        |             reviewer_id INTEGER REFERENCES employees(id) ON                                                 DELETE SET NULL,
isp_crm_db        |             review_period_start DATE NOT NULL,
isp_crm_db        |             review_period_end DATE NOT NULL,
isp_crm_db        |             overall_rating INTEGER CHECK (overall_rating >=                                                 1 AND overall_rating <= 5),
isp_crm_db        |             productivity_rating INTEGER CHECK (productivity_                                                rating >= 1 AND productivity_rating <= 5),
isp_crm_db        |             quality_rating INTEGER CHECK (quality_rating >=                                                 1 AND quality_rating <= 5),
isp_crm_db        |             teamwork_rating INTEGER CHECK (teamwork_rating >                                                = 1 AND teamwork_rating <= 5),
isp_crm_db        |             communication_rating INTEGER CHECK (communicatio                                                n_rating >= 1 AND communication_rating <= 5),
isp_crm_db        |             goals_achieved TEXT,
isp_crm_db        |             strengths TEXT,
isp_crm_db        |             areas_for_improvement TEXT,
isp_crm_db        |             goals_next_period TEXT,
isp_crm_db        |             comments TEXT,
isp_crm_db        |             status VARCHAR(20) DEFAULT 'draft',
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS company_settings (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             setting_key VARCHAR(100) UNIQUE NOT NULL,
isp_crm_db        |             setting_value TEXT,
isp_crm_db        |             setting_type VARCHAR(20) DEFAULT 'text',
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS settings (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             setting_key VARCHAR(100) UNIQUE NOT NULL,
isp_crm_db        |             setting_value TEXT,
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS ticket_templates (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             name VARCHAR(100) NOT NULL,
isp_crm_db        |             category VARCHAR(50),
isp_crm_db        |             subject VARCHAR(200),
isp_crm_db        |             content TEXT NOT NULL,
isp_crm_db        |             is_active BOOLEAN DEFAULT TRUE,
isp_crm_db        |             created_by INTEGER REFERENCES users(id) ON DELET                                                E SET NULL,
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS whatsapp_logs (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             ticket_id INTEGER REFERENCES tickets(id) ON DELE                                                TE CASCADE,
isp_crm_db        |             order_id INTEGER REFERENCES orders(id) ON DELETE                                                 CASCADE,
isp_crm_db        |             complaint_id INTEGER REFERENCES complaints(id) O                                                N DELETE CASCADE,
isp_crm_db        |             recipient_phone VARCHAR(20) NOT NULL,
isp_crm_db        |             recipient_type VARCHAR(20) NOT NULL,
isp_crm_db        |             message_type VARCHAR(50) DEFAULT 'custom',
isp_crm_db        |             message TEXT,
isp_crm_db        |             status VARCHAR(20) DEFAULT 'pending',
isp_crm_db        |             sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS biometric_devices (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             name VARCHAR(100) NOT NULL,
isp_crm_db        |             device_type VARCHAR(20) NOT NULL CHECK (device_t                                                ype IN ('zkteco', 'hikvision')),
isp_crm_db        |             ip_address VARCHAR(45) NOT NULL,
isp_crm_db        |             port INTEGER DEFAULT 4370,
isp_crm_db        |             username VARCHAR(100),
isp_crm_db        |             password_encrypted TEXT,
isp_crm_db        |             serial_number VARCHAR(100),
isp_crm_db        |             sync_interval_minutes INTEGER DEFAULT 15,
isp_crm_db        |             is_active BOOLEAN DEFAULT TRUE,
isp_crm_db        |             last_sync_at TIMESTAMP,
isp_crm_db        |             last_sync_status VARCHAR(50),
isp_crm_db        |             last_sync_message TEXT,
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS biometric_attendance_logs                                                 (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             device_id INTEGER REFERENCES biometric_devices(i                                                d) ON DELETE CASCADE,
isp_crm_db        |             employee_id INTEGER REFERENCES employees(id) ON                                                 DELETE CASCADE,
isp_crm_db        |             device_user_id VARCHAR(50) NOT NULL,
isp_crm_db        |             log_time TIMESTAMP NOT NULL,
isp_crm_db        |             direction VARCHAR(10) CHECK (direction IN ('in',                                                 'out', 'unknown')),
isp_crm_db        |             verification_type VARCHAR(20),
isp_crm_db        |             raw_data JSONB,
isp_crm_db        |             synced_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             processed BOOLEAN DEFAULT FALSE,
isp_crm_db        |             UNIQUE(device_id, device_user_id, log_time)
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS device_user_mapping (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             device_id INTEGER REFERENCES biometric_devices(i                                                d) ON DELETE CASCADE,
isp_crm_db        |             device_user_id VARCHAR(50) NOT NULL,
isp_crm_db        |             employee_id INTEGER REFERENCES employees(id) ON                                                 DELETE CASCADE,
isp_crm_db        |             device_user_name VARCHAR(100),
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             UNIQUE(device_id, device_user_id)
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS late_rules (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             name VARCHAR(100) NOT NULL,
isp_crm_db        |             work_start_time TIME NOT NULL DEFAULT '09:00',
isp_crm_db        |             grace_minutes INTEGER DEFAULT 15,
isp_crm_db        |             deduction_tiers JSONB NOT NULL DEFAULT '[]',
isp_crm_db        |             currency VARCHAR(10) DEFAULT 'KES',
isp_crm_db        |             apply_to_department_id INTEGER REFERENCES depart                                                ments(id) ON DELETE SET NULL,
isp_crm_db        |             is_default BOOLEAN DEFAULT FALSE,
isp_crm_db        |             is_active BOOLEAN DEFAULT TRUE,
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS payroll_deductions (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             payroll_id INTEGER REFERENCES payroll(id) ON DEL                                                ETE CASCADE,
isp_crm_db        |             employee_id INTEGER REFERENCES employees(id) ON                                                 DELETE CASCADE,
isp_crm_db        |             deduction_type VARCHAR(50) NOT NULL,
isp_crm_db        |             description TEXT,
isp_crm_db        |             amount DECIMAL(12, 2) NOT NULL,
isp_crm_db        |             details JSONB,
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS service_packages (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             name VARCHAR(100) NOT NULL,
isp_crm_db        |             slug VARCHAR(100) UNIQUE NOT NULL,
isp_crm_db        |             description TEXT,
isp_crm_db        |             speed VARCHAR(50) NOT NULL,
isp_crm_db        |             speed_unit VARCHAR(10) DEFAULT 'Mbps',
isp_crm_db        |             price DECIMAL(10, 2) NOT NULL,
isp_crm_db        |             currency VARCHAR(10) DEFAULT 'KES',
isp_crm_db        |             billing_cycle VARCHAR(20) DEFAULT 'monthly',
isp_crm_db        |             features JSONB DEFAULT '[]',
isp_crm_db        |             is_popular BOOLEAN DEFAULT FALSE,
isp_crm_db        |             is_active BOOLEAN DEFAULT TRUE,
isp_crm_db        |             display_order INTEGER DEFAULT 0,
isp_crm_db        |             badge_text VARCHAR(50),
isp_crm_db        |             badge_color VARCHAR(20),
isp_crm_db        |             icon VARCHAR(50) DEFAULT 'wifi',
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         ALTER TABLE attendance ADD COLUMN IF NOT EXISTS late                                                _minutes INTEGER DEFAULT 0;
isp_crm_db        |         ALTER TABLE attendance ADD COLUMN IF NOT EXISTS sour                                                ce VARCHAR(20) DEFAULT 'manual';
isp_crm_db        |         ALTER TABLE attendance ADD COLUMN IF NOT EXISTS biom                                                etric_log_id INTEGER;
isp_crm_db        |
isp_crm_db        |         ALTER TABLE tickets ADD COLUMN IF NOT EXISTS closure                                                _details JSONB DEFAULT '{}';
isp_crm_db        |         ALTER TABLE tickets ADD COLUMN IF NOT EXISTS equipme                                                nt_used_id INTEGER REFERENCES equipment(id);
isp_crm_db        |
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_tickets_customer ON t                                                ickets(customer_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_tickets_assigned ON t                                                ickets(assigned_to);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_tickets_status ON tic                                                kets(status);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_tickets_created ON ti                                                ckets(created_at DESC);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_ticket_comments_ticke                                                t ON ticket_comments(ticket_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_sms_logs_ticket ON sm                                                s_logs(ticket_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_sms_logs_sent ON sms_                                                logs(sent_at DESC);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_customers_account ON                                                 customers(account_number);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_customers_name ON cus                                                tomers(name);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_customers_phone ON cu                                                stomers(phone);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_employees_department                                                 ON employees(department_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_employees_status ON e                                                mployees(employment_status);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_employees_emp_id ON e                                                mployees(employee_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_attendance_employee O                                                N attendance(employee_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_attendance_date ON at                                                tendance(date);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_payroll_employee ON p                                                ayroll(employee_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_payroll_period ON pay                                                roll(pay_period_start, pay_period_end);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_payroll_status ON pay                                                roll(status);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_performance_employee                                                 ON performance_reviews(employee_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_ticket_templates_cate                                                gory ON ticket_templates(category);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_company_settings_key                                                 ON company_settings(setting_key);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_whatsapp_logs_ticket                                                 ON whatsapp_logs(ticket_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_whatsapp_logs_sent ON                                                 whatsapp_logs(sent_at DESC);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_biometric_devices_act                                                ive ON biometric_devices(is_active);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_biometric_logs_device                                                 ON biometric_attendance_logs(device_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_biometric_logs_employ                                                ee ON biometric_attendance_logs(employee_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_biometric_logs_time O                                                N biometric_attendance_logs(log_time);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_biometric_logs_proces                                                sed ON biometric_attendance_logs(processed);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_device_mapping_device                                                 ON device_user_mapping(device_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_device_mapping_employ                                                ee ON device_user_mapping(employee_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_late_rules_active ON                                                 late_rules(is_active);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_payroll_deductions_pa                                                yroll ON payroll_deductions(payroll_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_payroll_deductions_em                                                ployee ON payroll_deductions(employee_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_payroll_deductions_ty                                                pe ON payroll_deductions(deduction_type);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_service_packages_acti                                                ve ON service_packages(is_active);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_service_packages_orde                                                r ON service_packages(display_order);
isp_crm_db        |
isp_crm_db        | 2025-12-08 12:35:36.924 UTC [62] ERROR:  relation "company_s                                                ettings" does not exist at character 54
isp_crm_db        | 2025-12-08 12:35:36.924 UTC [62] STATEMENT:  SELECT setting_                                                key, setting_value, setting_type FROM company_settings
isp_crm_db        | 2025-12-08 12:35:36.925 UTC [62] ERROR:  relation "service_p                                                ackages" does not exist at character 15
isp_crm_db        | 2025-12-08 12:35:36.925 UTC [62] STATEMENT:  SELECT * FROM s                                                ervice_packages WHERE is_active = true ORDER BY display_order ASC, price ASC
isp_crm_db        | 2025-12-08 12:35:48.525 UTC [63] ERROR:  relation "orders" d                                                oes not exist
isp_crm_db        | 2025-12-08 12:35:48.525 UTC [63] STATEMENT:
isp_crm_db        |         CREATE TABLE IF NOT EXISTS users (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             name VARCHAR(100) NOT NULL,
isp_crm_db        |             email VARCHAR(100) UNIQUE NOT NULL,
isp_crm_db        |             phone VARCHAR(20) NOT NULL,
isp_crm_db        |             password_hash VARCHAR(255),
isp_crm_db        |             role VARCHAR(20) NOT NULL DEFAULT 'technician',
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS customers (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             account_number VARCHAR(20) UNIQUE NOT NULL,
isp_crm_db        |             name VARCHAR(100) NOT NULL,
isp_crm_db        |             email VARCHAR(100),
isp_crm_db        |             phone VARCHAR(20) NOT NULL,
isp_crm_db        |             address TEXT NOT NULL,
isp_crm_db        |             service_plan VARCHAR(50) NOT NULL,
isp_crm_db        |             connection_status VARCHAR(20) DEFAULT 'active',
isp_crm_db        |             installation_date DATE,
isp_crm_db        |             notes TEXT,
isp_crm_db        |             created_by INTEGER REFERENCES users(id) ON DELET                                                E SET NULL,
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS tickets (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             ticket_number VARCHAR(20) UNIQUE NOT NULL,
isp_crm_db        |             customer_id INTEGER REFERENCES customers(id) ON                                                 DELETE CASCADE,
isp_crm_db        |             assigned_to INTEGER REFERENCES users(id) ON DELE                                                TE SET NULL,
isp_crm_db        |             created_by INTEGER REFERENCES users(id) ON DELET                                                E SET NULL,
isp_crm_db        |             subject VARCHAR(200) NOT NULL,
isp_crm_db        |             description TEXT NOT NULL,
isp_crm_db        |             category VARCHAR(50) NOT NULL,
isp_crm_db        |             priority VARCHAR(20) DEFAULT 'medium',
isp_crm_db        |             status VARCHAR(20) DEFAULT 'open',
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             resolved_at TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS ticket_comments (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             ticket_id INTEGER REFERENCES tickets(id) ON DELE                                                TE CASCADE,
isp_crm_db        |             user_id INTEGER REFERENCES users(id) ON DELETE S                                                ET NULL,
isp_crm_db        |             comment TEXT NOT NULL,
isp_crm_db        |             is_internal BOOLEAN DEFAULT FALSE,
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS sms_logs (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             ticket_id INTEGER REFERENCES tickets(id) ON DELE                                                TE CASCADE,
isp_crm_db        |             recipient_phone VARCHAR(20) NOT NULL,
isp_crm_db        |             recipient_type VARCHAR(20) NOT NULL,
isp_crm_db        |             message TEXT NOT NULL,
isp_crm_db        |             status VARCHAR(20) DEFAULT 'pending',
isp_crm_db        |             sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS departments (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             name VARCHAR(100) NOT NULL,
isp_crm_db        |             description TEXT,
isp_crm_db        |             manager_id INTEGER,
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS employees (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             employee_id VARCHAR(20) UNIQUE NOT NULL,
isp_crm_db        |             user_id INTEGER REFERENCES users(id) ON DELETE S                                                ET NULL,
isp_crm_db        |             name VARCHAR(100) NOT NULL,
isp_crm_db        |             email VARCHAR(100),
isp_crm_db        |             phone VARCHAR(20) NOT NULL,
isp_crm_db        |             department_id INTEGER REFERENCES departments(id)                                                 ON DELETE SET NULL,
isp_crm_db        |             position VARCHAR(100) NOT NULL,
isp_crm_db        |             salary DECIMAL(12, 2),
isp_crm_db        |             hire_date DATE,
isp_crm_db        |             employment_status VARCHAR(20) DEFAULT 'active',
isp_crm_db        |             emergency_contact VARCHAR(100),
isp_crm_db        |             emergency_phone VARCHAR(20),
isp_crm_db        |             address TEXT,
isp_crm_db        |             notes TEXT,
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         ALTER TABLE departments DROP CONSTRAINT IF EXISTS fk                                                _manager;
isp_crm_db        |         DO $$ BEGIN
isp_crm_db        |             IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE                                                 conname = 'fk_manager') THEN
isp_crm_db        |                 ALTER TABLE departments ADD CONSTRAINT fk_ma                                                nager FOREIGN KEY (manager_id) REFERENCES employees(id) ON DELETE SET NULL;
isp_crm_db        |             END IF;
isp_crm_db        |         END $$;
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS attendance (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             employee_id INTEGER REFERENCES employees(id) ON                                                 DELETE CASCADE,
isp_crm_db        |             date DATE NOT NULL,
isp_crm_db        |             clock_in TIME,
isp_crm_db        |             clock_out TIME,
isp_crm_db        |             clock_in_latitude DECIMAL(10, 8),
isp_crm_db        |             clock_in_longitude DECIMAL(11, 8),
isp_crm_db        |             clock_out_latitude DECIMAL(10, 8),
isp_crm_db        |             clock_out_longitude DECIMAL(11, 8),
isp_crm_db        |             clock_in_address TEXT,
isp_crm_db        |             clock_out_address TEXT,
isp_crm_db        |             status VARCHAR(20) DEFAULT 'present',
isp_crm_db        |             hours_worked DECIMAL(5, 2),
isp_crm_db        |             overtime_hours DECIMAL(5, 2) DEFAULT 0,
isp_crm_db        |             notes TEXT,
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             UNIQUE(employee_id, date)
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS payroll (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             employee_id INTEGER REFERENCES employees(id) ON                                                 DELETE CASCADE,
isp_crm_db        |             pay_period_start DATE NOT NULL,
isp_crm_db        |             pay_period_end DATE NOT NULL,
isp_crm_db        |             base_salary DECIMAL(12, 2) NOT NULL,
isp_crm_db        |             overtime_pay DECIMAL(12, 2) DEFAULT 0,
isp_crm_db        |             bonuses DECIMAL(12, 2) DEFAULT 0,
isp_crm_db        |             deductions DECIMAL(12, 2) DEFAULT 0,
isp_crm_db        |             tax DECIMAL(12, 2) DEFAULT 0,
isp_crm_db        |             net_pay DECIMAL(12, 2) NOT NULL,
isp_crm_db        |             status VARCHAR(20) DEFAULT 'pending',
isp_crm_db        |             payment_date DATE,
isp_crm_db        |             payment_method VARCHAR(50),
isp_crm_db        |             notes TEXT,
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS performance_reviews (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             employee_id INTEGER REFERENCES employees(id) ON                                                 DELETE CASCADE,
isp_crm_db        |             reviewer_id INTEGER REFERENCES employees(id) ON                                                 DELETE SET NULL,
isp_crm_db        |             review_period_start DATE NOT NULL,
isp_crm_db        |             review_period_end DATE NOT NULL,
isp_crm_db        |             overall_rating INTEGER CHECK (overall_rating >=                                                 1 AND overall_rating <= 5),
isp_crm_db        |             productivity_rating INTEGER CHECK (productivity_                                                rating >= 1 AND productivity_rating <= 5),
isp_crm_db        |             quality_rating INTEGER CHECK (quality_rating >=                                                 1 AND quality_rating <= 5),
isp_crm_db        |             teamwork_rating INTEGER CHECK (teamwork_rating >                                                = 1 AND teamwork_rating <= 5),
isp_crm_db        |             communication_rating INTEGER CHECK (communicatio                                                n_rating >= 1 AND communication_rating <= 5),
isp_crm_db        |             goals_achieved TEXT,
isp_crm_db        |             strengths TEXT,
isp_crm_db        |             areas_for_improvement TEXT,
isp_crm_db        |             goals_next_period TEXT,
isp_crm_db        |             comments TEXT,
isp_crm_db        |             status VARCHAR(20) DEFAULT 'draft',
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS company_settings (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             setting_key VARCHAR(100) UNIQUE NOT NULL,
isp_crm_db        |             setting_value TEXT,
isp_crm_db        |             setting_type VARCHAR(20) DEFAULT 'text',
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS settings (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             setting_key VARCHAR(100) UNIQUE NOT NULL,
isp_crm_db        |             setting_value TEXT,
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS ticket_templates (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             name VARCHAR(100) NOT NULL,
isp_crm_db        |             category VARCHAR(50),
isp_crm_db        |             subject VARCHAR(200),
isp_crm_db        |             content TEXT NOT NULL,
isp_crm_db        |             is_active BOOLEAN DEFAULT TRUE,
isp_crm_db        |             created_by INTEGER REFERENCES users(id) ON DELET                                                E SET NULL,
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS whatsapp_logs (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             ticket_id INTEGER REFERENCES tickets(id) ON DELE                                                TE CASCADE,
isp_crm_db        |             order_id INTEGER REFERENCES orders(id) ON DELETE                                                 CASCADE,
isp_crm_db        |             complaint_id INTEGER REFERENCES complaints(id) O                                                N DELETE CASCADE,
isp_crm_db        |             recipient_phone VARCHAR(20) NOT NULL,
isp_crm_db        |             recipient_type VARCHAR(20) NOT NULL,
isp_crm_db        |             message_type VARCHAR(50) DEFAULT 'custom',
isp_crm_db        |             message TEXT,
isp_crm_db        |             status VARCHAR(20) DEFAULT 'pending',
isp_crm_db        |             sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS biometric_devices (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             name VARCHAR(100) NOT NULL,
isp_crm_db        |             device_type VARCHAR(20) NOT NULL CHECK (device_t                                                ype IN ('zkteco', 'hikvision')),
isp_crm_db        |             ip_address VARCHAR(45) NOT NULL,
isp_crm_db        |             port INTEGER DEFAULT 4370,
isp_crm_db        |             username VARCHAR(100),
isp_crm_db        |             password_encrypted TEXT,
isp_crm_db        |             serial_number VARCHAR(100),
isp_crm_db        |             sync_interval_minutes INTEGER DEFAULT 15,
isp_crm_db        |             is_active BOOLEAN DEFAULT TRUE,
isp_crm_db        |             last_sync_at TIMESTAMP,
isp_crm_db        |             last_sync_status VARCHAR(50),
isp_crm_db        |             last_sync_message TEXT,
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS biometric_attendance_logs                                                 (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             device_id INTEGER REFERENCES biometric_devices(i                                                d) ON DELETE CASCADE,
isp_crm_db        |             employee_id INTEGER REFERENCES employees(id) ON                                                 DELETE CASCADE,
isp_crm_db        |             device_user_id VARCHAR(50) NOT NULL,
isp_crm_db        |             log_time TIMESTAMP NOT NULL,
isp_crm_db        |             direction VARCHAR(10) CHECK (direction IN ('in',                                                 'out', 'unknown')),
isp_crm_db        |             verification_type VARCHAR(20),
isp_crm_db        |             raw_data JSONB,
isp_crm_db        |             synced_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             processed BOOLEAN DEFAULT FALSE,
isp_crm_db        |             UNIQUE(device_id, device_user_id, log_time)
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS device_user_mapping (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             device_id INTEGER REFERENCES biometric_devices(i                                                d) ON DELETE CASCADE,
isp_crm_db        |             device_user_id VARCHAR(50) NOT NULL,
isp_crm_db        |             employee_id INTEGER REFERENCES employees(id) ON                                                 DELETE CASCADE,
isp_crm_db        |             device_user_name VARCHAR(100),
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             UNIQUE(device_id, device_user_id)
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS late_rules (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             name VARCHAR(100) NOT NULL,
isp_crm_db        |             work_start_time TIME NOT NULL DEFAULT '09:00',
isp_crm_db        |             grace_minutes INTEGER DEFAULT 15,
isp_crm_db        |             deduction_tiers JSONB NOT NULL DEFAULT '[]',
isp_crm_db        |             currency VARCHAR(10) DEFAULT 'KES',
isp_crm_db        |             apply_to_department_id INTEGER REFERENCES depart                                                ments(id) ON DELETE SET NULL,
isp_crm_db        |             is_default BOOLEAN DEFAULT FALSE,
isp_crm_db        |             is_active BOOLEAN DEFAULT TRUE,
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS payroll_deductions (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             payroll_id INTEGER REFERENCES payroll(id) ON DEL                                                ETE CASCADE,
isp_crm_db        |             employee_id INTEGER REFERENCES employees(id) ON                                                 DELETE CASCADE,
isp_crm_db        |             deduction_type VARCHAR(50) NOT NULL,
isp_crm_db        |             description TEXT,
isp_crm_db        |             amount DECIMAL(12, 2) NOT NULL,
isp_crm_db        |             details JSONB,
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         CREATE TABLE IF NOT EXISTS service_packages (
isp_crm_db        |             id SERIAL PRIMARY KEY,
isp_crm_db        |             name VARCHAR(100) NOT NULL,
isp_crm_db        |             slug VARCHAR(100) UNIQUE NOT NULL,
isp_crm_db        |             description TEXT,
isp_crm_db        |             speed VARCHAR(50) NOT NULL,
isp_crm_db        |             speed_unit VARCHAR(10) DEFAULT 'Mbps',
isp_crm_db        |             price DECIMAL(10, 2) NOT NULL,
isp_crm_db        |             currency VARCHAR(10) DEFAULT 'KES',
isp_crm_db        |             billing_cycle VARCHAR(20) DEFAULT 'monthly',
isp_crm_db        |             features JSONB DEFAULT '[]',
isp_crm_db        |             is_popular BOOLEAN DEFAULT FALSE,
isp_crm_db        |             is_active BOOLEAN DEFAULT TRUE,
isp_crm_db        |             display_order INTEGER DEFAULT 0,
isp_crm_db        |             badge_text VARCHAR(50),
isp_crm_db        |             badge_color VARCHAR(20),
isp_crm_db        |             icon VARCHAR(50) DEFAULT 'wifi',
isp_crm_db        |             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
isp_crm_db        |             updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
isp_crm_db        |         );
isp_crm_db        |
isp_crm_db        |         ALTER TABLE attendance ADD COLUMN IF NOT EXISTS late                                                _minutes INTEGER DEFAULT 0;
isp_crm_db        |         ALTER TABLE attendance ADD COLUMN IF NOT EXISTS sour                                                ce VARCHAR(20) DEFAULT 'manual';
isp_crm_db        |         ALTER TABLE attendance ADD COLUMN IF NOT EXISTS biom                                                etric_log_id INTEGER;
isp_crm_db        |
isp_crm_db        |         ALTER TABLE tickets ADD COLUMN IF NOT EXISTS closure                                                _details JSONB DEFAULT '{}';
isp_crm_db        |         ALTER TABLE tickets ADD COLUMN IF NOT EXISTS equipme                                                nt_used_id INTEGER REFERENCES equipment(id);
isp_crm_db        |
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_tickets_customer ON t                                                ickets(customer_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_tickets_assigned ON t                                                ickets(assigned_to);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_tickets_status ON tic                                                kets(status);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_tickets_created ON ti                                                ckets(created_at DESC);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_ticket_comments_ticke                                                t ON ticket_comments(ticket_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_sms_logs_ticket ON sm                                                s_logs(ticket_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_sms_logs_sent ON sms_                                                logs(sent_at DESC);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_customers_account ON                                                 customers(account_number);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_customers_name ON cus                                                tomers(name);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_customers_phone ON cu                                                stomers(phone);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_employees_department                                                 ON employees(department_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_employees_status ON e                                                mployees(employment_status);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_employees_emp_id ON e                                                mployees(employee_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_attendance_employee O                                                N attendance(employee_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_attendance_date ON at                                                tendance(date);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_payroll_employee ON p                                                ayroll(employee_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_payroll_period ON pay                                                roll(pay_period_start, pay_period_end);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_payroll_status ON pay                                                roll(status);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_performance_employee                                                 ON performance_reviews(employee_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_ticket_templates_cate                                                gory ON ticket_templates(category);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_company_settings_key                                                 ON company_settings(setting_key);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_whatsapp_logs_ticket                                                 ON whatsapp_logs(ticket_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_whatsapp_logs_sent ON                                                 whatsapp_logs(sent_at DESC);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_biometric_devices_act                                                ive ON biometric_devices(is_active);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_biometric_logs_device                                                 ON biometric_attendance_logs(device_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_biometric_logs_employ                                                ee ON biometric_attendance_logs(employee_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_biometric_logs_time O                                                N biometric_attendance_logs(log_time);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_biometric_logs_proces                                                sed ON biometric_attendance_logs(processed);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_device_mapping_device                                                 ON device_user_mapping(device_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_device_mapping_employ                                                ee ON device_user_mapping(employee_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_late_rules_active ON                                                 late_rules(is_active);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_payroll_deductions_pa                                                yroll ON payroll_deductions(payroll_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_payroll_deductions_em                                                ployee ON payroll_deductions(employee_id);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_payroll_deductions_ty                                                pe ON payroll_deductions(deduction_type);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_service_packages_acti                                                ve ON service_packages(is_active);
isp_crm_db        |         CREATE INDEX IF NOT EXISTS idx_service_packages_orde                                                r ON service_packages(display_order);
isp_crm_db        |
isp_crm_php       | NOTICE: PHP message: Database initialization failed: SQLSTAT                                                E[42P01]: Undefined table: 7 ERROR:  relation "orders" does not exist
isp_crm_db        | 2025-12-08 12:35:48.536 UTC [63] ERROR:  relation "company_s                                                ettings" does not exist at character 54
isp_crm_db        | 2025-12-08 12:35:48.536 UTC [63] STATEMENT:  SELECT setting_                                                key, setting_value, setting_type FROM company_settings
isp_crm_db        | 2025-12-08 12:35:48.537 UTC [63] ERROR:  relation "service_p                                                ackages" does not exist at character 15
isp_crm_db        | 2025-12-08 12:35:48.537 UTC [63] STATEMENT:  SELECT * FROM s                                                ervice_packages WHERE is_active = true ORDER BY display_order ASC, price ASC
isp_crm_php       | NOTICE: PHP message: PHP Fatal error:  Uncaught PDOException                                                : SQLSTATE[42P01]: Undefined table: 7 ERROR:  relation "service_packages" does n                                                ot exist
isp_crm_php       | LINE 1: SELECT * FROM service_packages WHERE is_active = tru                                                e ORDER ...
isp_crm_php       |                       ^ in /var/www/html/src/Settings.php:46                                                0
isp_crm_php       | Stack trace:
isp_crm_php       | #0 /var/www/html/src/Settings.php(460): PDO->query()
isp_crm_php       | #1 /var/www/html/src/Settings.php(475): App\Settings->getAll                                                Packages()
isp_crm_php       | #2 /var/www/html/public/index.php(608): App\Settings->getAct                                                ivePackagesForLanding()
isp_crm_php       | #3 {main}
isp_crm_php       |   thrown in /var/www/html/src/Settings.php on line 460
isp_crm_php       | 172.18.0.5 -  08/Dec/2025:12:35:48 +0000 "GET /index.php" 50                                                0
isp_crm_nginx     | 102.205.239.250 - - [08/Dec/2025:12:35:48 +0000] "GET / HTTP                                                /1.1" 500 5 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (K                                                HTML, like Gecko) Chrome/143.0.0.0 Safari/537.36" "-"