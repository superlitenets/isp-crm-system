<?php
/**
 * Huawei ONU TR-069 Provisioning via GenieACS API
 * 
 * Requirements:
 * - PHP >= 7.4
 * - cURL enabled
 */

$acsUrl = "http://10.200.0.1:7557"; // GenieACS base URL
$serialNumber = "00259E-HG8546M-48575443F2D53A8B"; // Replace with your ONU SN

// Step 1: VLAN
$parametersStep1 = [
    ["InternetGatewayDevice.WANDevice.1.WANConnectionDevice.1.WANPPPConnection.1.X_HW_VLAN", 902, "xsd:unsignedInt"]
];

// Step 2: Username & Password
$parametersStep2 = [
    ["InternetGatewayDevice.WANDevice.1.WANConnectionDevice.1.WANPPPConnection.1.Username", "2116", "xsd:string"],
    ["InternetGatewayDevice.WANDevice.1.WANConnectionDevice.1.WANPPPConnection.1.Password", "2116", "xsd:string"]
];

// Step 3: NAT & ConnectionType
$parametersStep3 = [
    ["InternetGatewayDevice.WANDevice.1.WANConnectionDevice.1.WANPPPConnection.1.NATEnabled", true, "xsd:boolean"],
    ["InternetGatewayDevice.WANDevice.1.WANConnectionDevice.1.WANPPPConnection.1.ConnectionType", "IP_Routed", "xsd:string"]
];

// Step 4: Enable WAN
$parametersStep4 = [
    ["InternetGatewayDevice.WANDevice.1.WANConnectionDevice.1.WANPPPConnection.1.Enable", true, "xsd:boolean"]
];

// Step 5: Enable L3 on ETH1–4
$parametersStep5 = [
    ["InternetGatewayDevice.LANDevice.1.LANEthernetInterfaceConfig.1.X_HW_L3Enable", true, "xsd:boolean"],
    ["InternetGatewayDevice.LANDevice.1.LANEthernetInterfaceConfig.2.X_HW_L3Enable", true, "xsd:boolean"],
    ["InternetGatewayDevice.LANDevice.1.LANEthernetInterfaceConfig.3.X_HW_L3Enable", true, "xsd:boolean"],
    ["InternetGatewayDevice.LANDevice.1.LANEthernetInterfaceConfig.4.X_HW_L3Enable", true, "xsd:boolean"]
];

/**
 * Helper function to call GenieACS setParameterValues
 */
function setParameters($acsUrl, $serialNumber, $parameters) {
    $url = $acsUrl . "/devices/$serialNumber/tasks";
    $data = [
        "name" => "setParameterValues",
        "parameterValues" => $parameters
    ];
    $ch = curl_init($url);
    curl_setopt($ch, CURLOPT_HTTPHEADER, ["Content-Type: application/json"]);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $response = curl_exec($ch);
    if(curl_errno($ch)) {
        echo "cURL error: " . curl_error($ch) . PHP_EOL;
    }
    curl_close($ch);
    echo "Response: $response" . PHP_EOL;
}

// Execute each step with short delay to allow ONU processing
echo "[Step 1] Set VLAN..." . PHP_EOL;
setParameters($acsUrl, $serialNumber, $parametersStep1);
sleep(5);

echo "[Step 2] Set Username & Password..." . PHP_EOL;
setParameters($acsUrl, $serialNumber, $parametersStep2);
sleep(5);

echo "[Step 3] Set NAT & ConnectionType..." . PHP_EOL;
setParameters($acsUrl, $serialNumber, $parametersStep3);
sleep(5);

echo "[Step 4] Enable WAN..." . PHP_EOL;
setParameters($acsUrl, $serialNumber, $parametersStep4);
sleep(10); // Give ONU time to establish PPPoE

echo "[Step 5] Enable L3 on ETH1–4..." . PHP_EOL;
setParameters($acsUrl, $serialNumber, $parametersStep5);

echo "Provisioning task completed. Check WANPPPConnection.1 status in GenieACS." . PHP_EOL;
