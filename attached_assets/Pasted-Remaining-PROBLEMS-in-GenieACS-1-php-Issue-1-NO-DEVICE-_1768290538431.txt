Remaining PROBLEMS in GenieACS (1).php
âŒ Issue #1 â€” NO DEVICE STATE GUARD (IMPORTANT)

You still allow provisioning without checking ONU state.

Example problem:

ONU reboots

Sends Inform

CRM re-runs provisioning

SmartOLT prevents this with:

NEW â†’ PROVISIONING â†’ ACTIVE

ğŸ”§ Fix (mandatory)

Add a device state column:

devices.state ENUM('NEW','PROVISIONING','ACTIVE','FAILED')


Then guard provisioning:

if ($device['state'] !== 'NEW') return;

âŒ Issue #2 â€” No idempotency check before addObject

Your code still does:

addObject
setParameterValues


If object already exists:

Huawei ONU creates duplicates

Policy routing breaks

SmartOLT never blindly adds.

ğŸ”§ Fix

Before addObject, query GenieACS device data:

GET /devices/{id}


Check:

Existing WANPPPConnection

Existing WANIPConnection

Existing policy routes

âŒ Issue #3 â€” WAN HTTP control missing final hard lock

Your earlier logs showed:

HTTPWanEnable:1
Administrator exceeded maximum login attempts


Your corrected file does not guarantee a final lock.

ğŸ”§ Fix

Always push at END:

HTTPWanEnable = 0


Even if provisioning fails.

3ï¸âƒ£ HuaweiOLT (2).php â€” REVIEW
âœ… What is now CORRECT
âœ” No longer provisioning ONUs directly

This is very important.

Your file now:

Reads ONU / OLT info

Does NOT configure services

âœ… This removes the multi-writer conflict that was killing stability.

âœ” OLT responsibility is correct

Your OLT code now focuses on:

Discovery

Inventory

Optical data

SmartOLT does the same separation.

âš ï¸ Remaining PROBLEMS in HuaweiOLT (2).php
âŒ Issue #4 â€” OLT and ACS logic still coupled (soft issue)

You still allow OLT logic to:

Trigger provisioning directly

This is dangerous.

ğŸ”§ Fix

OLT â†’ CRM â†’ ACS (GenieACS)
Never:

OLT â†’ ACS

âŒ Issue #5 â€” No rate limiting / debounce on events

OLT events (LOS, reboot, re-register) can happen fast.

Without debounce:

CRM may queue multiple GenieACS tasks

ONU gets flooded

SmartOLT debounces hard.

ğŸ”§ Fix

Add:

if (last_provision_attempt < NOW() - INTERVAL 10 MINUTE)

4ï¸âƒ£ CRITICAL ISSUE STILL PRESENT (from logs)

Your system still risks this:

1981-01-01 timestamps


Meaning:

ONU provisioning starts before NTP sync

ğŸ”§ REQUIRED FIX (must do)

Before ANY provisioning:

GET InternetGatewayDevice.DeviceInfo.UpTime
GET InternetGatewayDevice.DeviceInfo.CurrentTime


If year < 2020:
â¡ Push ONLY NTP
â¡ Wait for next Inform

SmartOLT does this.

5ï¸âƒ£ Comparison vs SmartOLT (current state)
Feature	SmartOLT	Your system
Single ACS	âœ…	âœ…
No direct ONU writes	âœ…	âœ…
Correct Huawei paths	âœ…	âœ…
State machine	âœ…	âŒ
Idempotent provisioning	âœ…	âŒ
NTP gate	âœ…	âŒ
Debounce	âœ…	âŒ

You are very close, but these last items matter.

6ï¸âƒ£ FINAL VERDICT
âœ… The corrections were GOOD
âŒ The system is not yet production-safe
âš ï¸ Remaining issues are design-level, not syntax

If you deploy now:

It will work

But youâ€™ll still see:

Duplicate WANs

Random Wi-Fi binding failures

Occasional resets